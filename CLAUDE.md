# CLAUDE.md

This file provides guidance to Claude Code when working with code in this repository.

## Project Overview

**AI é«˜ç®¡æ•™ç»ƒ**æ˜¯ä¸€æ¬¾é¢å‘ä¼ä¸šé«˜ç®¡çš„å¾®ä¿¡å°ç¨‹åºï¼Œé€šè¿‡å¼•å¯¼å¼å¯¹è¯å¸®åŠ©é«˜ç®¡ç†æ¸…æ€è·¯ã€åšå‡ºæ›´å¥½çš„å†³ç­–ã€‚åŸºäº Taro 3 + React 18 æ¡†æ¶å¼€å‘ï¼Œåç«¯ä½¿ç”¨ FastAPI + PostgreSQLï¼Œé›†æˆç«å±±å¼•æ“è±†åŒ… AI æ¨¡å‹ã€‚

## Tech Stack

### å‰ç«¯ï¼ˆå¾®ä¿¡å°ç¨‹åºï¼‰
- **æ¡†æ¶**: Taro 3.6.0 + React 18.2.0
- **è¯­è¨€**: TypeScript
- **æ ·å¼**: SCSS + Tweakcn ä¸»é¢˜
- **æ„å»º**: Webpack 5

### åç«¯
- **æ¡†æ¶**: FastAPI (Python)
- **æ•°æ®åº“**: PostgreSQL 18.0
- **ORM**: SQLAlchemy
- **è®¤è¯**: JWT + å¾®ä¿¡å°ç¨‹åºç™»å½•
- **AI**: ç«å±±å¼•æ“è±†åŒ… (doubao-seed-1-6-lite-251015)

## Development Commands

### å‰ç«¯

```bash
# å®‰è£…ä¾èµ–
cd miniapp
npm install --legacy-peer-deps

# å¼€å‘æ¨¡å¼
npm run dev:weapp

# ç”Ÿäº§æ„å»º
npm run build:weapp
```

### åç«¯

```bash
# å®‰è£…ä¾èµ–
cd server
pip install fastapi uvicorn sqlalchemy psycopg2-binary httpx pyjwt python-dotenv

# å¯åŠ¨æœåŠ¡
uvicorn app:app --reload

# æµ‹è¯•
curl http://localhost:8000/health
```

## Environment Configuration

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# æ•°æ®åº“
DATABASE_URL=postgresql://postgres:your_password@localhost:5432/ai_coach_db

# ç«å±±å¼•æ“ API
OPENAI_API_KEY=your_api_key
OPENAI_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
OPENAI_MODEL=doubao-seed-1-6-lite-251015

# JWT
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=7d

# å¾®ä¿¡å°ç¨‹åº
WECHAT_APP_ID=your_appid
WECHAT_APP_SECRET=your_secret
```

## Architecture

### Project Structure

```
ai-coach/
â”œâ”€â”€ miniapp/                    # å°ç¨‹åºå‰ç«¯
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ app.tsx            # åº”ç”¨å…¥å£
â”‚   â”‚   â”œâ”€â”€ app.config.ts      # å°ç¨‹åºé…ç½®
â”‚   â”‚   â”œâ”€â”€ app.scss           # å…¨å±€æ ·å¼
â”‚   â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts       # å¸¸é‡é…ç½®ï¼ˆAPIã€å·¥å…·ã€äººæ ¼ï¼‰
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”œâ”€â”€ index/         # AI æ•™ç»ƒå¯¹è¯é¡µ
â”‚   â”‚   â”‚   â”œâ”€â”€ tools/         # å•†ä¸šå·¥å…·é¡µ
â”‚   â”‚   â”‚   â”œâ”€â”€ connect/       # è¿æ¥æˆ‘ä»¬é¡µ
â”‚   â”‚   â”‚   â””â”€â”€ authorize/     # ç”¨æˆ·æˆæƒé¡µ
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ api.ts         # HTTP API å°è£…
â”‚   â”‚   â”‚   â””â”€â”€ websocket.ts   # WebSocket æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts        # è®¤è¯å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ storage.ts     # æœ¬åœ°å­˜å‚¨
â”‚   â”‚   â”‚   â”œâ”€â”€ usage.ts       # ä½¿ç”¨æ¬¡æ•°ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ nfc.ts         # NFC å”¤é†’
â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts       # TypeScript ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ styles/
â”‚   â”‚       â””â”€â”€ theme.scss     # Tweakcn ä¸»é¢˜é…ç½®
â”‚   â””â”€â”€ dist/                  # ç¼–è¯‘è¾“å‡ºï¼ˆå¾®ä¿¡å¼€å‘è€…å·¥å…·å¯¼å…¥æ­¤ç›®å½•ï¼‰
â”œâ”€â”€ server/                     # åç«¯æœåŠ¡
â”‚   â”œâ”€â”€ app.py                 # FastAPI ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ auth.py            # å¾®ä¿¡ç™»å½• API
â”‚   â”‚   â”œâ”€â”€ chat.py            # ä¼šè¯ç®¡ç† API
â”‚   â”‚   â””â”€â”€ usage.py           # ä½¿ç”¨æ¬¡æ•° API
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ user.py            # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ chat_session.py    # ä¼šè¯æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ chat_message.py    # æ¶ˆæ¯æ¨¡å‹
â”‚   â”‚   â””â”€â”€ usage_log.py       # ä½¿ç”¨è®°å½•æ¨¡å‹
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ database.py        # æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ websocket/
â”‚       â””â”€â”€ chat_handler.py    # WebSocket èŠå¤©å¤„ç†å™¨
â”œâ”€â”€ database/
â”‚   â””â”€â”€ migrations/
â”‚       â””â”€â”€ 001_init.sql       # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â””â”€â”€ .env                       # ç¯å¢ƒå˜é‡
```

### Database Schema

```sql
-- ç”¨æˆ·è¡¨
users (id, openid, phone, nickname, avatar_url, daily_quota, purchased_quota, is_premium, created_at)

-- ä¼šè¯è¡¨
chat_sessions (id, user_id, tool_type, created_at)

-- æ¶ˆæ¯è¡¨
chat_messages (id, session_id, role, content, created_at)

-- ä½¿ç”¨è®°å½•è¡¨
usage_logs (id, user_id, date, count, created_at)
```

### Key Files & Responsibilities

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `miniapp/src/app.tsx` | å°ç¨‹åºå…¥å£ï¼Œå¤„ç† NFC å”¤é†’ã€è‡ªåŠ¨ç™»å½•å’Œæˆæƒè·³è½¬ |
| `miniapp/src/pages/authorize/index.tsx` | ç”¨æˆ·æˆæƒé¡µé¢ï¼Œè·å–æ˜µç§°ã€å¤´åƒã€æ‰‹æœºå· |
| `miniapp/src/constants/index.ts` | é…ç½® API åœ°å€ã€å•†ä¸šå·¥å…·ã€AI äººæ ¼ |
| `miniapp/src/services/websocket.ts` | WebSocket è¿æ¥ç®¡ç†ã€è‡ªåŠ¨é‡è¿ã€å¿ƒè·³ |
| `miniapp/src/services/api.ts` | HTTP API å°è£…ã€Token æ³¨å…¥ |
| `miniapp/src/pages/index/index.tsx` | AI å¯¹è¯é¡µé¢ã€æµå¼å“åº”ã€ä¼šè¯ç®¡ç† |
| `miniapp/src/styles/theme.scss` | Tweakcn ä¸»é¢˜å˜é‡ï¼ˆrpx å•ä½ï¼‰ |
| `server/app.py` | FastAPI åº”ç”¨ã€è·¯ç”±æ³¨å†Œã€CORS é…ç½® |
| `server/routes/auth.py` | å¾®ä¿¡ç™»å½•ã€ç”¨æˆ·ä¿¡æ¯æ›´æ–°ã€JWT Token ç”Ÿæˆ |
| `server/routes/chat.py` | ä¼šè¯ CRUDã€Token éªŒè¯ |
| `server/routes/usage.py` | ä½¿ç”¨æ¬¡æ•°æ£€æŸ¥å’Œå¢åŠ  |
| `server/routes/admin.py` | ç®¡ç†åå° APIï¼ˆç”¨æˆ·åˆ—è¡¨ã€é…é¢ç®¡ç†ï¼‰ |
| `server/websocket/chat_handler.py` | WebSocket å¤„ç†ã€æµå¼ AI å“åº”ã€æ¶ˆæ¯æŒä¹…åŒ– |

## Code Patterns

### å‰ç«¯

#### ç»„ä»¶ç»“æ„
- å‡½æ•°å¼ç»„ä»¶ + Hooksï¼ˆuseState, useEffect, useRefï¼‰
- Props æ¥å£å®šä¹‰åœ¨ `types/index.ts`
- ä½¿ç”¨ Taro APIï¼ˆTaro.request, Taro.connectSocket, Taro.loginï¼‰

#### æ ·å¼è§„èŒƒ
- ä½¿ç”¨ `rpx` å•ä½ï¼ˆå°ç¨‹åºå“åº”å¼å•ä½ï¼Œ750rpx = å±å¹•å®½åº¦ï¼‰
- ä» `theme.scss` å¯¼å…¥ä¸»é¢˜å˜é‡
- é¿å…ä½¿ç”¨é€šé…ç¬¦é€‰æ‹©å™¨ `*`ï¼ˆWXSS ä¸æ”¯æŒï¼‰

#### æ•°æ®æµ
```
ç”¨æˆ·æ“ä½œ â†’ ç»„ä»¶çŠ¶æ€æ›´æ–° â†’ API/WebSocket è°ƒç”¨ â†’ åç«¯å¤„ç† â†’ æ•°æ®åº“æŒä¹…åŒ–
                â†“
         UI æ›´æ–° â†’ ç”¨æˆ·åé¦ˆ
```

### åç«¯

#### API å“åº”æ ¼å¼
```python
{
    "code": 0,           # 0 è¡¨ç¤ºæˆåŠŸï¼Œé 0 è¡¨ç¤ºé”™è¯¯
    "message": "success",
    "data": {...}        # å®é™…æ•°æ®
}
```

#### WebSocket æ¶ˆæ¯æ ¼å¼
```python
# ä¼šè¯ ID
{"type": "session", "sessionId": "uuid"}

# æµå¼æ–‡æœ¬å—
{"type": "chunk", "content": "æ–‡æœ¬"}

# å®Œæˆä¿¡å·
{"type": "done", "sessionId": "uuid"}

# é”™è¯¯
{"type": "error", "error": "é”™è¯¯ä¿¡æ¯"}
```

## Important Notes

### å‰ç«¯æ³¨æ„äº‹é¡¹

1. **React ç‰ˆæœ¬**: å¿…é¡»ä½¿ç”¨ React 18.2.0ï¼ˆTaro 4.1.9 ä¸å…¼å®¹ React 19ï¼‰
2. **ç¯å¢ƒå˜é‡**: å°ç¨‹åºä¸æ”¯æŒ `process.env`ï¼Œç›´æ¥ç¡¬ç¼–ç é…ç½®
3. **API åœ°å€**: å¼€å‘ç¯å¢ƒä½¿ç”¨ `http://localhost:8000`ï¼Œç”Ÿäº§ç¯å¢ƒéœ€é…ç½®åŸŸåç™½åå•
4. **rpx å•ä½**: æ‰€æœ‰å°ºå¯¸ä½¿ç”¨ rpxï¼Œ1rpx â‰ˆ 0.5pxï¼ˆiPhone 6 åŸºå‡†ï¼‰
5. **WXSS é™åˆ¶**: ä¸æ”¯æŒé€šé…ç¬¦é€‰æ‹©å™¨ã€æŸäº› CSS3 ç‰¹æ€§

### åç«¯æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡**: å¿…é¡»é€šè¿‡ `.env` æ–‡ä»¶åŠ è½½ï¼ˆä½¿ç”¨ `python-dotenv`ï¼‰
2. **æ•°æ®åº“è¿æ¥**: ä½¿ç”¨ SQLAlchemyï¼Œè¿æ¥å­—ç¬¦ä¸²ä»ç¯å¢ƒå˜é‡è¯»å–
3. **JWT è®¤è¯**: æ‰€æœ‰éœ€è¦è®¤è¯çš„ API ä½¿ç”¨ `get_user_id_from_token` ä¾èµ–
4. **WebSocket**: ä½¿ç”¨ FastAPI åŸç”Ÿ WebSocket æ”¯æŒ
5. **æµå¼å“åº”**: ç«å±±å¼•æ“ API è¿”å› SSE æ ¼å¼ï¼Œéœ€é€è¡Œè§£æ

### AI å¯¹è¯ç‰¹æ€§

1. **ç³»ç»Ÿæç¤ºè¯**: é«˜ç®¡æ•™ç»ƒäººæ ¼ï¼Œå¼ºè°ƒå¼•å¯¼å¼å¯¹è¯
2. **å†å²ä¸Šä¸‹æ–‡**: æŸ¥è¯¢æœ€è¿‘ 20 æ¡æ¶ˆæ¯ï¼Œä¿æŒå¯¹è¯è¿è´¯
3. **é”™è¯¯é‡è¯•**: æœ€å¤šé‡è¯• 2 æ¬¡ï¼Œå¤±è´¥åå‘ç”¨æˆ·æ˜¾ç¤ºé”™è¯¯
4. **æ¶ˆæ¯æŒä¹…åŒ–**: æ‰€æœ‰å¯¹è¯è‡ªåŠ¨å­˜å…¥æ•°æ®åº“

## Completed Tasks

### âœ… å·²å®Œæˆ

- å°ç¨‹åºå‰ç«¯æ¡†æ¶æ­å»ºï¼ˆTaro 4 + React 18ï¼‰
- åç«¯ API å®ç°ï¼ˆFastAPI + PostgreSQLï¼‰
- å¾®ä¿¡ç™»å½•é›†æˆï¼ˆJWT Tokenï¼‰
- ç”¨æˆ·ä¿¡æ¯æˆæƒï¼ˆæ˜µç§°ã€å¤´åƒã€æ‰‹æœºå·ï¼‰
- æµå¼ AI å¯¹è¯ï¼ˆWebSocket + ç«å±±å¼•æ“ï¼‰
- ä¼šè¯ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€åˆ‡æ¢ï¼‰
- ä½¿ç”¨æ¬¡æ•°ç®¡ç†ï¼ˆæ¯æ—¥å…è´¹é…é¢ + è´­ä¹°æ¬¡æ•°ï¼‰
- ç®¡ç†åå°ï¼ˆç”¨æˆ·ç®¡ç†ã€é…é¢ç®¡ç†ã€æ‰‹æœºå·æœç´¢ï¼‰
- å†å²å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆæœ€è¿‘ 20 æ¡ï¼‰
- é”™è¯¯é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š 2 æ¬¡ï¼‰
- æ•°æ®åº“æŒä¹…åŒ–ï¼ˆç”¨æˆ·ã€ä¼šè¯ã€æ¶ˆæ¯ã€ä½¿ç”¨è®°å½•ï¼‰
- æ•°æ®åº“è¿ç§»å·¥å…·ï¼ˆPython è„šæœ¬ï¼‰
- Tweakcn ä¸»é¢˜é…ç½®ï¼ˆSCSS + rpxï¼‰
- å•†ä¸šå·¥å…· 2/3 å±å¯¹è¯çª—å£ï¼ˆé«˜æ–¯æ¨¡ç³ŠèƒŒæ™¯ï¼‰
- WebSocket æµå¼å¯¹è¯ä¿®å¤ï¼ˆTaro 4 å…¨å±€ APIï¼‰
- ä»£ç è´¨é‡ä¼˜åŒ–ï¼š
  - âœ… åˆå¹¶é‡å¤çš„ CSS åŠ¨ç”»å®šä¹‰ï¼ˆå‡å°‘ 30 è¡Œä»£ç ï¼‰
  - âœ… æ ‡å‡†åŒ–æ—¥å¿—è®°å½•ï¼ˆlogger.error æ›¿ä»£ printï¼‰
  - âœ… æå–é‡å¤çš„ TypeScript ç±»å‹å®šä¹‰
  - âœ… åˆ é™¤æœªä½¿ç”¨çš„å¯¼å…¥ã€çŠ¶æ€ã€å‡½æ•°
  - âœ… æ¸…ç†è°ƒè¯•ä»£ç ï¼ˆconsole.log/printï¼‰
- æ–‡æ¡£æ›´æ–°ï¼ˆREADME.md + CLAUDE.mdï¼‰

### ğŸš§ å¾…å®Œæˆ

- å¾®ä¿¡å°ç¨‹åºè´¦å·ç”³è¯·
- æœåŠ¡å™¨éƒ¨ç½²ï¼ˆGunicorn + Nginxï¼‰
- åŸŸåé…ç½®å’Œ SSL è¯ä¹¦
- ç”Ÿäº§ç¯å¢ƒæµ‹è¯•

## Development Tips

### è°ƒè¯•å°ç¨‹åº

1. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­å¯¼å…¥ `miniapp/dist` ç›®å½•
2. å‹¾é€‰"ä¸æ ¡éªŒåˆæ³•åŸŸå"ï¼ˆå¼€å‘é˜¶æ®µï¼‰
3. ä½¿ç”¨ Console æŸ¥çœ‹æ—¥å¿—
4. ä½¿ç”¨ Network æŸ¥çœ‹è¯·æ±‚

### è°ƒè¯•åç«¯

1. è®¿é—® http://localhost:8000/docs æŸ¥çœ‹ API æ–‡æ¡£
2. ä½¿ç”¨ curl æˆ– Postman æµ‹è¯• API
3. æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—
4. ä½¿ç”¨ PostgreSQL å®¢æˆ·ç«¯æŸ¥çœ‹æ•°æ®åº“

### å¸¸è§é—®é¢˜

**Q: å°ç¨‹åºç™½å±ï¼Ÿ**
A: æ£€æŸ¥ Console é”™è¯¯ï¼Œé€šå¸¸æ˜¯ API åœ°å€é…ç½®é”™è¯¯æˆ– WXSS è¯­æ³•é”™è¯¯

**Q: WebSocket è¿æ¥å¤±è´¥ï¼Ÿ**
A: ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œï¼Œæ£€æŸ¥ API åœ°å€é…ç½®

**Q: æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Ÿ**
A: æ£€æŸ¥ `.env` ä¸­çš„ `DATABASE_URL`ï¼Œç¡®ä¿ PostgreSQL æœåŠ¡è¿è¡Œ

**Q: React ç‰ˆæœ¬å†²çªï¼Ÿ**
A: ä½¿ç”¨ `npm install --legacy-peer-deps` å®‰è£…ä¾èµ–

## Code Quality Notes

### âœ… å·²å®Œæˆä¼˜åŒ–ï¼ˆ2025-12-05ï¼‰

1. **åˆå¹¶é‡å¤çš„ CSS åŠ¨ç”»å®šä¹‰**
   - ä» `miniapp/src/pages/index/index.scss` å’Œ `miniapp/src/pages/tools/index.scss` ä¸­åˆ é™¤é‡å¤çš„åŠ¨ç”»
   - å°† `@keyframes thinking`ã€`@keyframes blink`ã€`@keyframes slideUp` åˆå¹¶åˆ°å…¨å±€ä¸»é¢˜æ–‡ä»¶ `miniapp/src/styles/theme.scss`
   - å‡å°‘äº†çº¦ 30 è¡Œé‡å¤ä»£ç 

2. **æ ‡å‡†åŒ–æ—¥å¿—è®°å½•**
   - å°† `server/websocket/chat_handler.py` çš„ `print()` æ”¹ä¸ºæ ‡å‡†çš„ `logger.error()`
   - æ·»åŠ äº† `exc_info=True` å‚æ•°ä»¥è·å–å®Œæ•´çš„å¼‚å¸¸å †æ ˆä¿¡æ¯
   - ä½¿ä»£ç æ›´ç¬¦åˆç”Ÿäº§ç¯å¢ƒçš„æ—¥å¿—æœ€ä½³å®è·µ

3. **æå–é‡å¤çš„ç±»å‹å®šä¹‰**
   - ä»ä¸¤ä¸ªé¡µé¢ç»„ä»¶ä¸­åˆ é™¤é‡å¤çš„ `Message` æ¥å£å®šä¹‰
   - å°†å…¶é›†ä¸­åˆ° `miniapp/src/types/index.ts` ä½œä¸ºå…±äº«ç±»å‹
   - ç¡®ä¿ç±»å‹å®šä¹‰çš„å•ä¸€æ¥æºï¼ˆSingle Source of Truthï¼‰

### ğŸ¯ ä»£ç è´¨é‡çŠ¶æ€

- âœ… æ— å¤šä½™çš„è°ƒè¯•è¯­å¥ï¼ˆconsole.log/printï¼‰
- âœ… æ— ç©ºçš„å¼‚å¸¸å¤„ç†å—
- âœ… API URL ç»Ÿä¸€é…ç½®åœ¨å¸¸é‡æ–‡ä»¶
- âœ… æ— é‡å¤çš„æ ·å¼å’ŒåŠ¨ç”»å®šä¹‰
- âœ… ç±»å‹å®šä¹‰é›†ä¸­ç®¡ç†
- âœ… æ ‡å‡†åŒ–çš„æ—¥å¿—è®°å½•

### ğŸ“‹ å¾…ä¼˜åŒ–å»ºè®®

#### ä¸­ä¼˜å…ˆçº§
- æå–é‡å¤çš„ Base64 è½¬æ¢é€»è¾‘
- æ›¿æ¢ `any` ç±»å‹ä¸ºå…·ä½“ç±»å‹

#### ä½ä¼˜å…ˆçº§
- ä¼˜åŒ–æ€§èƒ½ï¼ˆä½¿ç”¨ useCallback, useMemoï¼‰
- æå–é­”æ³•æ•°å­—ä¸ºå¸¸é‡

---

## UI/UX ä¼˜åŒ–è®°å½•

### 2025-12-05 æ›´æ–°
- âœ… å…¨å±€èƒŒæ™¯è‰²æ”¹ä¸º `#F0EEE6`ï¼ˆæ¸©æš–ç±³è‰²ï¼‰
- âœ… å·¥å…·å¡ç‰‡èƒŒæ™¯è‰²æ”¹ä¸º `#E3DACC`
- âœ… å·¥å…·å¡ç‰‡åˆ é™¤å›¾æ ‡ï¼Œæ ‡é¢˜åŠ ç²—æ”¾å¤§
- âœ… è‡ªå®šä¹‰å¯¼èˆªæ ä¸å¾®ä¿¡èƒ¶å›ŠæŒ‰é’®å¯¹é½ï¼ˆpadding-top: 88rpx, min-height: 176rpxï¼‰
- âœ… è¾“å…¥æ æ‚¬æµ®æ•ˆæœï¼ˆposition: fixed, bottom: 0, background: transparentï¼‰
- âœ… è”ç³»æˆ‘ä»¬é¡µé¢åº•éƒ¨æŒ‰é’®å›ºå®šåœ¨ä¸è¾“å…¥æ ç›¸åŒä½ç½®
- âœ… è”ç³»æˆ‘ä»¬é¡µé¢æŒ‰é’®é¢œè‰²æ”¹ä¸º `#c96442`
- âœ… è”ç³»å¡ç‰‡èƒŒæ™¯è‰²æ”¹ä¸º `#E3DACC`

### 2025-12-04 æ›´æ–°
- âœ… åˆ é™¤ AI å¯¹è¯é¡µé¢é¡¶éƒ¨"AI é«˜ç®¡æ•™ç»ƒ"æ ‡é¢˜
- âœ… é‡æ–°è®¾è®¡è¾“å…¥æ ï¼Œå‘é€æŒ‰é’®ç§»åˆ°è¾“å…¥æ¡†å†…éƒ¨
- âœ… å‘é€æŒ‰é’®æ”¹ä¸ºåœ†å½¢å›¾æ ‡ï¼Œå†…éƒ¨ç®­å¤´é¢œè‰²ä¸ºç™½è‰²
- âœ… å·¥å…·é¡µé¢æ ‡é¢˜å±…ä¸­ï¼Œåˆ é™¤æè¿°æ–‡å­—
- âœ… å·¥å…·å¡ç‰‡æ”¹ä¸ºé•¿æ–¹å½¢åˆ—è¡¨å¸ƒå±€ï¼ˆæ¯è¡Œ1ä¸ªï¼‰
- âœ… å·¥å…·æ ‡ç­¾ç§»åˆ°æ ‡é¢˜åæ–¹å±•ç¤º
- âœ… åˆ é™¤å·¥å…·é¡µé¢åº•éƒ¨æç¤ºå¡ç‰‡
- âœ… è”ç³»æˆ‘ä»¬é¡µé¢åˆ é™¤é¡¶éƒ¨æè¿°åŒºåŸŸ
- âœ… é¡¶éƒ¨å¯¼èˆªæ”¹ä¸ºå·¦å³å›¾æ ‡æŒ‰é’® + ä¸­é—´é…é¢æ˜¾ç¤º
- âœ… å·¦ä¸Šè§’å†å²å¯¹è¯å›¾æ ‡ï¼ˆ#c96442è‰²ï¼‰
- âœ… å³ä¸Šè§’æ–°å¯¹è¯æŒ‰é’®ï¼ˆCSSç»˜åˆ¶çš„åŠ å·ï¼Œ#c96442è‰²ï¼‰
- âœ… ç”¨æˆ·æ¶ˆæ¯å³ä¾§ç•™ç™½ï¼Œé¿å…è¶…å‡ºå±å¹•
- âœ… åˆ é™¤è¾“å…¥æ¡†ä¸Šæ–¹çš„å·¥å…·å¿«é€Ÿé€‰æ‹©æ ï¼ˆç®€åŒ–ç•Œé¢ï¼‰
- âœ… WebSocket æµå¼å¯¹è¯ä¿®å¤ï¼ˆTaro 4 APIï¼‰
- âœ… ä»£ç æ¸…ç†ï¼šåˆ é™¤æœªä½¿ç”¨çš„å¯¼å…¥ã€çŠ¶æ€ã€å‡½æ•°ã€é‡å¤é€»è¾‘
- âœ… é…é¢æ˜¾ç¤ºä¼˜åŒ–ï¼ˆå…è´¹æ¬¡æ•° + è´­ä¹°æ¬¡æ•°ï¼‰
- âœ… ç”¨æˆ·æˆæƒé¡µé¢ï¼ˆé¦–æ¬¡ä½¿ç”¨è·å–æ˜µç§°ã€å¤´åƒã€æ‰‹æœºå·ï¼‰
- âœ… ç®¡ç†åå°æ‰‹æœºå·æœç´¢åŠŸèƒ½ä¿®å¤ï¼ˆç©ºå€¼ä¿æŠ¤ï¼‰

---

## Technical Implementation Notes

### WebSocket å®ç°ï¼ˆTaro 4ï¼‰
- ä½¿ç”¨å…¨å±€ APIï¼š`Taro.connectSocket()`, `Taro.onSocketOpen()`, `Taro.sendSocketMessage()`
- é¿å…ä½¿ç”¨ SocketTask å®ä¾‹æ–¹æ³•ï¼ˆTaro 4 è¿”å› Promiseï¼‰
- æµå¼æ–‡æœ¬é€šè¿‡ `setStreamingText` å›è°ƒè·å–æœ€æ–°å€¼

### ç”¨æˆ·æˆæƒæµç¨‹
1. ç”¨æˆ·é¦–æ¬¡æ‰“å¼€å°ç¨‹åºï¼Œè°ƒç”¨ `wx.login()` è·å– code
2. åç«¯ç”¨ code æ¢å– openidï¼Œåˆ›å»ºç”¨æˆ·è®°å½•ï¼Œè¿”å› JWT token å’Œ `needProfile` æ ‡å¿—
3. å¦‚æœ `needProfile` ä¸º trueï¼Œè·³è½¬åˆ°æˆæƒé¡µé¢ `/pages/authorize/index`
4. æˆæƒé¡µé¢ä½¿ç”¨ `<button open-type="chooseAvatar">` è·å–å¤´åƒ
5. ä½¿ç”¨ `<input type="nickname">` è·å–æ˜µç§°
6. ä½¿ç”¨ `<button open-type="getPhoneNumber">` è·å–æ‰‹æœºå· code
7. è°ƒç”¨åç«¯ `/auth/update-profile` æ¥å£ï¼Œåç«¯ç”¨ code æ¢å–æ‰‹æœºå·å¹¶æ›´æ–°ç”¨æˆ·ä¿¡æ¯
8. æˆæƒæˆåŠŸåè·³è½¬åˆ°é¦–é¡µ

---

## ç®¡ç†åå° (Admin Dashboard)

### æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: React 18 + Vite
- **UI åº“**: shadcn/ui + TailwindCSS
- **ä¸»é¢˜**: Claude Theme (from theme.md)
- **è¯­è¨€**: TypeScript

### åŠŸèƒ½ç‰¹æ€§
1. **ç”¨æˆ·ç®¡ç†**
   - ç”¨æˆ·åˆ—è¡¨å±•ç¤ºï¼ˆæ‰‹æœºå·ã€æ˜µç§°ã€é…é¢ä¿¡æ¯ï¼‰
   - æ‰‹æœºå·æ¨¡ç³Šæœç´¢
   - å®æ—¶æ•°æ®åˆ·æ–°

2. **è´­ä¹°æ¬¡æ•°ç®¡ç†**
   - å¿«é€Ÿé€‰æ‹©ï¼š+20æ¬¡ã€+50æ¬¡ã€+100æ¬¡ã€æ— é™æ¬¡æ•°
   - è‡ªå®šä¹‰å¢å‡ï¼ˆæ”¯æŒæ­£è´Ÿæ•°ï¼‰
   - å®æ—¶åŒæ­¥åˆ°æ•°æ®åº“

3. **è®¤è¯ç³»ç»Ÿ**
   - ç®€å•å¯†ç è®¤è¯ï¼ˆadmin/123456ï¼‰
   - Basic Auth Token
   - è‡ªåŠ¨ç™»å½•çŠ¶æ€ä¿æŒ

### å¼€å‘å‘½ä»¤

```bash
cd admin
npm install          # å®‰è£…ä¾èµ–
npm run dev          # å¼€å‘æœåŠ¡å™¨ (http://localhost:5175)
npm run build        # ç”Ÿäº§æ„å»º
```

### API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/admin/login` | POST | ç®¡ç†å‘˜ç™»å½• |
| `/api/admin/users` | GET | è·å–ç”¨æˆ·åˆ—è¡¨ |
| `/api/admin/users/{id}/quota` | POST | ä¿®æ”¹è´­ä¹°æ¬¡æ•° |

### æ•°æ®åº“å­—æ®µ

**users è¡¨æ–°å¢å­—æ®µ**ï¼š
- `phone` (VARCHAR(20)) - ç”¨æˆ·æ‰‹æœºå·
- `purchased_quota` (INT, DEFAULT 0) - è´­ä¹°æ¬¡æ•°

### é…é¢æ‰£å‡é€»è¾‘

```python
# ä¼˜å…ˆæ‰£æ¯æ—¥å…è´¹æ¬¡æ•°
if daily_used < user.daily_quota:
    usage.count += 1
else:
    # æ‰£è´­ä¹°æ¬¡æ•°
    if user.purchased_quota > 0:
        user.purchased_quota -= 1
    else:
        return {"code": 1, "message": "æ¬¡æ•°ä¸è¶³"}
```

### å°ç¨‹åºé…é¢æ˜¾ç¤º

```typescript
// æ˜¾ç¤ºï¼šå‰©ä½™æ¬¡æ•° / æ€»æ¬¡æ•°
const totalRemaining = daily_remaining + purchased_remaining
const totalQuota = daily_quota + purchased_quota
// ä¾‹å¦‚ï¼š15/20 (æ¯æ—¥10æ¬¡ + è´­ä¹°10æ¬¡)
```

---

## æ•°æ®åº“è¿ç§»

### è¿ç§»å·¥å…·

ä½¿ç”¨ Python è„šæœ¬æ‰§è¡Œè¿ç§»ï¼ˆæ¨èï¼‰ï¼š

```bash
cd database/migrations
python migrate.py
```

### è¿ç§»å†å²

| ç‰ˆæœ¬ | æ–‡ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|------|
| 001 | `001_init.sql` | åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„ | âœ… å·²æ‰§è¡Œ |
| 002 | `002_add_purchased_quota.sql` | æ·»åŠ è´­ä¹°æ¬¡æ•°å­—æ®µ | âœ… å·²æ‰§è¡Œ |
| 003 | `003_add_phone_field.sql` | æ·»åŠ æ‰‹æœºå·å­—æ®µ | âœ… å·²æ‰§è¡Œ |

### è¿ç§»æ–‡æ¡£

- `database/migrations/README.md` - å®Œæ•´è¿ç§»æ–‡æ¡£
- `database/migrations/QUICKSTART.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—
- `database/migrations/MIGRATION_COMPLETE.md` - è¿ç§»å®ŒæˆæŠ¥å‘Š

---

**é¡¹ç›®çŠ¶æ€**: ä»£ç è´¨é‡ä¼˜åŒ–å®Œæˆï¼Œç”Ÿäº§å°±ç»ªï¼Œå¾…éƒ¨ç½²
**æœ€åæ›´æ–°**: 2025-12-05
